<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gestion des Voitures</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .option-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .option-item {
            display: flex;
            flex-direction: column;
        }

        .option-input {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Gestion des Voitures</h1>

        <!-- Button to Open the Add Modal -->
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addVoitureModal">Ajouter une Voiture</button>

        <!-- Add Voiture Modal -->
        <div class="modal fade" id="addVoitureModal" tabindex="-1" aria-labelledby="addVoitureModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addVoitureModalLabel">Ajouter une Voiture</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addVoitureForm" action="/voitures/createVoiture" method="post">
                            <div class="mb-3">
                                <label for="modele" class="form-label">Modèle</label>
                                <input type="text" id="modele" name="modele" class="form-control" placeholder="Entrer le modèle" required>
                            </div>
                            <div class="mb-3">
                                <label for="prix" class="form-label">Prix</label>
                                <input type="number" step="0.01" id="prix" name="prix" class="form-control" placeholder="Entrer le prix" required>
                            </div>
                            <div class="mb-3">
                                <label for="disponibilite" class="form-label">Disponibilité</label>
                                <select id="disponibilite" name="disponibilite" class="form-select" required>
                                    <option value="DISPONIBLE_IMMEDIATEMENT">Disponible Immédiatement</option>
                                    <option value="DISPONIBLE_SUR_COMMANDE">Disponible sur Commande</option>
                                    <option value="NON_DISPONIBLE">Non Disponible</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="dateDisponibilite" class="form-label">Date de Disponibilité</label>
                                <input type="date" id="dateDisponibilite" name="date_disponibilite" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="photo" class="form-label">Photo</label>
                                <input type="text" name="photo" id="photo" placeholder="Enter the file path here" required>
                            </div>
                            <div class="mb-3">
                                <label for="options" class="form-label">Options</label>
                                <div id="addOptions" class="option-list">
                                    <div class="option-item">
                                        <input type="text" name="optionDescriptions" class="form-control option-input" placeholder="Description" required>
                                        <input type="number" name="optionPrices" class="form-control option-input" placeholder="Prix" required>
                                        <button type="button" class="btn btn-danger" onclick="removeOptionField(this)">Supprimer</button>
                                    </div>
                                </div>
                                    
                                </div>
                                <button type="button" class="btn btn-secondary" onclick="addOptionField('addOptions')">Ajouter une Option</button>
                            </div>
                            <button type="submit" class="btn btn-success">Ajouter</button>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    </div>
                </div>
            </div>
        </div>

        <hr class="my-4">

        <!-- Table to Display All Voitures -->
        <h2 class="mb-3">Liste des Voitures</h2>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Photo</th>
                    <th>ID</th>
                    <th>Modèle</th>
                    <th>Prix</th>
                    <th>Disponibilité</th>
                    <th>Date de Disponibilité</th>
                    <th>Options</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="voiture : ${voitures}">
                    <td>
                        <img th:src="${voiture.photo}" alt="Car photo" />
                    </td>
                    <td th:text="${voiture.id_voiture}"></td>
                    <td th:text="${voiture.modele}"></td>
                    <td th:text="${voiture.prix}"></td>
                    <td th:text="${voiture.disponibilite}"></td>
                    <td th:text="${voiture.date_disponibilite}"></td>
                    <td>
                        <ul>
                            <li th:each="option : ${voiture.options}" th:text="${option.description} + ' - ' + ${option.option_prix}"></li>
                        </ul>
                    </td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="openUpdateModal([[${voiture.id_voiture}]])">Modifier</button>
                        <form th:action="@{/voitures/{id}/delete(id=${voiture.id_voiture})}" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-danger btn-sm">Supprimer</button>
                        </form>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        function previewImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('photoPreview') || document.getElementById('updatePhotoPreview');
            if (file) {
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }
    
        function openUpdateModal(id) {
            fetch(`/voitures/${id}/edit`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(voiture => {
                    document.getElementById("updateIdVoiture").value = voiture.id_voiture;
                    document.getElementById("updateModele").value = voiture.modele;
                    document.getElementById("updatePrix").value = voiture.prix;
                    document.getElementById("updateDisponibilite").value = voiture.disponibilite;
                    document.getElementById("updateDateDisponibilite").value = voiture.date_disponibilite ? voiture.date_disponibilite.split('T')[0] : '';
                    populateOptionFields('updateOptions', voiture.options);
                    new bootstrap.Modal(document.getElementById('updateVoitureModal')).show();
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erreur',
                        text: 'Impossible de récupérer les données de la voiture.',
                    });
                });
        }
    
        function addOptionField(targetId) {
            const optionContainer = document.getElementById(targetId);
            const optionItem = document.createElement('div');
            optionItem.classList.add('option-item');
            optionItem.innerHTML = `
                <input type="text" name="optionDescriptions" class="form-control option-input" placeholder="Description" required>
                <input type="number" name="optionPrices" class="form-control option-input" placeholder="Prix" required>
                <button type="button" class="btn btn-danger" onclick="removeOptionField(this)">Supprimer</button>
            `;
            optionContainer.appendChild(optionItem);
        }
        
        function removeOptionField(button) {
            button.closest('.option-item').remove();
        }
    
        function populateOptionFields(targetId, options) {
            const optionContainer = document.getElementById(targetId);
            optionContainer.innerHTML = ''; // Clear existing options
            options.forEach((option, index) => {
                const optionItem = document.createElement('div');
                optionItem.classList.add('option-item');
                optionItem.innerHTML = `
                    <input type="text" name="optionDescriptions[${index}]" class="form-control option-input" value="${option.description}" required>
                    <input type="number" name="optionPrices[${index}]" class="form-control option-input" value="${option.prix}" required>
                    <button type="button" class="btn btn-danger" onclick="removeOptionField(this)">Supprimer</button>
                `;
                optionContainer.appendChild(optionItem);
            });
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>
</html>



    



